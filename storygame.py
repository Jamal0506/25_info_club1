import streamlit as st
import random

# --- 1. ìŠ¤í† ë¦¬ ë…¸ë“œ ì •ì˜ (ê²Œì„ì˜ í•µì‹¬ ë°ì´í„°) ---
# ê° ë…¸ë“œëŠ” 'text'ì™€ 'choices'ë¥¼ ê°€ì§
# 'choices'ëŠ” {ì„ íƒì§€ í…ìŠ¤íŠ¸: ë‹¤ìŒ ë…¸ë“œ ID} í˜•íƒœì˜ ë”•ì…”ë„ˆë¦¬
# íŠ¹ìˆ˜ í‚¤ì›Œë“œ: '__END__'ëŠ” ê²Œì„ ì¢…ë£Œë¥¼ ì˜ë¯¸ (ì—¬ê¸°ì„œëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
#            '__WIN__'ì€ ìŠ¹ë¦¬ ì—”ë”©ì„ ì˜ë¯¸
#            '__LOSE__'ëŠ” íŒ¨ë°° ì—”ë”©ì„ ì˜ë¯¸
#            '__ITEM_GET_KEY__': ì•„ì´í…œ íšë“ ì¡°ê±´ ('ì•„ì´í…œ ì´ë¦„': 'ë‹¤ìŒ ë…¸ë“œ ID')
#            '__ITEM_CHECK_KEY__': ì•„ì´í…œ ë³´ìœ  ì—¬ë¶€ í™•ì¸ ì¡°ê±´ ('ì•„ì´í…œ ì´ë¦„': {'has': 'ë³´ìœ  ì‹œ ë…¸ë“œ ID', 'lacks': 'ë¯¸ë³´ìœ  ì‹œ ë…¸ë“œ ID'})

story_nodes = {
    "start": {
        "text": "ê¹Šì€ ë°¤, ë‹¹ì‹ ì€ ì–´ë‘ìš´ ìˆ² ì† ì™¸ë”´ ê¸¸ì„ ê±·ê³  ìˆìŠµë‹ˆë‹¤. ì € ë©€ë¦¬ í¬ë¯¸í•œ ë¶ˆë¹›ì´ ë³´ì…ë‹ˆë‹¤. ë‹¹ì‹ ì€ ì–´ë–»ê²Œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
        "choices": {
            "ë¶ˆë¹›ì„ í–¥í•´ ê°„ë‹¤.": "path_to_light",
            "ê¸¸ì„ ë”°ë¼ ê³„ì† ì§ì§„í•œë‹¤.": "continue_straight",
            "ìˆ² ì†ìœ¼ë¡œ ë“¤ì–´ê°€ ì§€ë¦„ê¸¸ì„ ì°¾ëŠ”ë‹¤.": "enter_forest"
        }
    },
    "path_to_light": {
        "text": "ë¶ˆë¹›ì— ê°€ê¹Œì›Œì§€ì, ë‚¡ì€ ì˜¤ë‘ë§‰ì´ ë³´ì…ë‹ˆë‹¤. ë¬¸ì´ ì‚´ì§ ì—´ë ¤ ìˆê³ , ì•ˆì—ì„œ ì‘ì€ ì†Œë¦¬ê°€ ë“¤ë¦½ë‹ˆë‹¤.",
        "choices": {
            "ì¡°ì‹¬ìŠ¤ëŸ½ê²Œ ë¬¸ì„ ì—´ê³  ë“¤ì–´ê°„ë‹¤.": "enter_cabin",
            "ì°½ë¬¸ìœ¼ë¡œ ì•ˆì„ ì—¿ë³¸ë‹¤.": "look_through_window",
            "ì˜¤ë‘ë§‰ì„ ì§€ë‚˜ì³ ê°„ë‹¤.": "continue_straight"
        }
    },
    "enter_cabin": {
        "text": "ì˜¤ë‘ë§‰ ì•ˆì—ëŠ” ëŠ™ì€ ë§ˆë…€ê°€ ì•½ì´ˆë¥¼ ë‹¤ë“¬ê³  ìˆìŠµë‹ˆë‹¤. ê·¸ë…€ëŠ” ë‹¹ì‹ ì„ ë³´ê³  ì˜ë¯¸ì‹¬ì¥í•œ ë¯¸ì†Œë¥¼ ì§“ìŠµë‹ˆë‹¤. ê·¸ë…€ì˜ ì†ì—ëŠ” ì˜¤ë˜ëœ ì—´ì‡ ê°€ ë³´ì…ë‹ˆë‹¤.",
        "choices": {
            "ì¸ì‚¬í•˜ê³  ë„ì›€ì„ ìš”ì²­í•œë‹¤.": "talk_to_witch",
            "ëª°ë˜ ì—´ì‡ ë¥¼ í›”ì¹œë‹¤.": "__LOSE__" # ë°”ë¡œ íŒ¨ë°° (ë§ˆë…€ì—ê²Œ ë“¤í‚´)
        }
    },
    "talk_to_witch": {
        "text": "ë§ˆë…€ëŠ” ë‹¹ì‹ ì˜ ì‚¬ì •ì„ ë“£ë”ë‹ˆ, 'ì´ ìˆ²ì„ í†µê³¼í•˜ë ¤ë©´ ì§€í˜œê°€ í•„ìš”í•˜ë‹¤. ì´ ì˜¤ë˜ëœ 'ìˆ²ì˜ ì§€í˜œ' ì—´ì‡ ë¥¼ ì¤„í…Œë‹ˆ, í˜„ëª…í•˜ê²Œ ì‚¬ìš©í•˜ê±°ë¼.' í•˜ë©° ì—´ì‡ ë¥¼ ê±´ë„µë‹ˆë‹¤.",
        "choices": {
            "ê°ì‚¬íˆ ë°›ê³  ê¸¸ì„ ë– ë‚œë‹¤.": "__ITEM_GET_KEY__", # ì—¬ê¸°ì„œ ì•„ì´í…œ íšë“ ë¡œì§ì´ íŠ¸ë¦¬ê±°ë¨
            "ë” ë§ì€ ê²ƒì„ ìš”êµ¬í•œë‹¤.": "__LOSE__" # íƒìš•ìœ¼ë¡œ ì¸í•´ íŒ¨ë°°
        },
        "item_get": {"ìˆ²ì˜ ì§€í˜œ ì—´ì‡ ": "exit_cabin_with_key"} # íšë“í•  ì•„ì´í…œê³¼ ë‹¤ìŒ ë…¸ë“œ
    },
    "exit_cabin_with_key": {
        "text": "ì—´ì‡ ë¥¼ ì–»ì€ ë‹¹ì‹ ì€ ì˜¤ë‘ë§‰ì„ ë‚˜ì™€ ë‹¤ì‹œ ê¸¸ì„ ê±·ìŠµë‹ˆë‹¤. ë©€ë¦¬ì„œ ìˆ˜ìƒí•œ ë¹„ëª…ì†Œë¦¬ê°€ ë“¤ë¦½ë‹ˆë‹¤.",
        "choices": {
            "ë¹„ëª…ì†Œë¦¬ê°€ ë‚˜ëŠ” ê³³ìœ¼ë¡œ ê°€ë³¸ë‹¤.": "investigate_scream",
            "ë¬´ì‹œí•˜ê³  ê³„ì† ê¸¸ì„ ê°„ë‹¤.": "continue_straight_after_cabin"
        }
    },
    "look_through_window": {
        "text": "ì°½ë¬¸ í‹ˆìœ¼ë¡œ ë³´ë‹ˆ, ë§ˆë…€ê°€ ì•½ì´ˆë¥¼ ë‹¤ë“¬ê³  ìˆìŠµë‹ˆë‹¤. ê·¸ë…€ì˜ ì˜†ì—ëŠ” ë¹›ë‚˜ëŠ” ë³´ì„ì´ ë†“ì—¬ ìˆìŠµë‹ˆë‹¤.",
        "choices": {
            "ë³´ì„ì„ í›”ì¹  ë°©ë²•ì„ ì°¾ëŠ”ë‹¤.": "__LOSE__", # ë“¤ì¼œì„œ íŒ¨ë°°
            "ê·¸ëƒ¥ ì§€ë‚˜ì³ ê°„ë‹¤.": "continue_straight"
        }
    },
    "continue_straight": {
        "text": "ê¸¸ì„ ë”°ë¼ ê³„ì† ì§ì§„í•˜ì, ê¸¸ì´ ë‘ ê°ˆë˜ë¡œ ë‚˜ë‰©ë‹ˆë‹¤. í•œìª½ì€ ì–´ë‘ìš´ ë™êµ´ ì…êµ¬ì´ê³ , ë‹¤ë¥¸ í•œìª½ì€ ì´ë¼ ë‚€ ë‚¡ì€ ë‹¤ë¦¬ì…ë‹ˆë‹¤.",
        "choices": {
            "ë™êµ´ë¡œ ë“¤ì–´ê°„ë‹¤.": "enter_cave",
            "ë‹¤ë¦¬ë¥¼ ê±´ë„Œë‹¤.": "cross_bridge"
        }
    },
    "continue_straight_after_cabin": { # ì˜¤ë‘ë§‰ì„ ë‚˜ì„  í›„ì˜ ì§ì§„
        "text": "ì˜¤ë‘ë§‰ì„ ë‚˜ì„  í›„ ê¸¸ì„ ë”°ë¼ ê³„ì† ì§ì§„í•˜ì, ê¸¸ì´ ë‘ ê°ˆë˜ë¡œ ë‚˜ë‰©ë‹ˆë‹¤. í•œìª½ì€ ì–´ë‘ìš´ ë™êµ´ ì…êµ¬ì´ê³ , ë‹¤ë¥¸ í•œìª½ì€ ì´ë¼ ë‚€ ë‚¡ì€ ë‹¤ë¦¬ì…ë‹ˆë‹¤.",
        "choices": {
            "ë™êµ´ë¡œ ë“¤ì–´ê°„ë‹¤.": "enter_cave",
            "ë‹¤ë¦¬ë¥¼ ê±´ë„Œë‹¤.": "cross_bridge"
        }
    },
    "enter_forest": {
        "text": "ìˆ² ì†ìœ¼ë¡œ ë“¤ì–´ê°€ìë§ˆì ê¸¸ì„ ìƒì—ˆìŠµë‹ˆë‹¤. ì–´ë‘  ì†ì—ì„œ ì•Œ ìˆ˜ ì—†ëŠ” ì†Œë¦¬ê°€ ë“¤ë¦¬ê³ , ë‹¹ì‹ ì€ ê³µí¬ì— ì§ˆë¦½ë‹ˆë‹¤.",
        "choices": {
            "ì†Œë¦¬ê°€ ë‚˜ëŠ” ê³³ìœ¼ë¡œ ìˆ¨ëŠ”ë‹¤.": "__LOSE__", # ì§ìŠ¹ì—ê²Œ ë°œê²¬ë¨
            "ë‹¤ì‹œ ê¸¸ì„ ì°¾ì•„ ìˆ² ë°–ìœ¼ë¡œ ë‚˜ê°„ë‹¤.": "try_to_exit_forest"
        }
    },
    "try_to_exit_forest": {
        "text": "í•œì°¸ì„ í—¤ë§¤ë‹¤ ë‹¤í–‰íˆ ê¸¸ì„ ì°¾ì•˜ì§€ë§Œ, ì§€ì³ ì“°ëŸ¬ì§‘ë‹ˆë‹¤.",
        "choices": {
            "í¬ê¸°í•œë‹¤.": "__LOSE__", # í”¼ë¡œë¡œ ì“°ëŸ¬ì ¸ ì‚¬ë§
            "ë§ˆì§€ë§‰ í˜ì„ ë‚´ì–´ ë‹¤ì‹œ ê±·ëŠ”ë‹¤.": "continue_straight" # ê²°êµ­ ê¸¸ë¡œ ë‚˜ì˜´
        }
    },
    "enter_cave": {
        "text": "ë™êµ´ ì†ì€ ë§¤ìš° ì–´ë‘¡ê³  ì¶•ì¶•í•©ë‹ˆë‹¤. ê¹Šì´ ë“¤ì–´ê°ˆìˆ˜ë¡ ì°¨ê°€ìš´ ë°”ëŒì´ ë¶ˆì–´ì˜µë‹ˆë‹¤. ì•ì—ëŠ” ê±°ëŒ€í•œ ë°”ìœ„ ë¬¸ì´ ë‹¹ì‹ ì˜ ê¸¸ì„ ë§‰ê³  ìˆìŠµë‹ˆë‹¤. ë¬¸ì—ëŠ” ì´ìƒí•œ ë¬¸ì–‘ì´ ìƒˆê²¨ì ¸ ìˆìŠµë‹ˆë‹¤.",
        "choices": {
            "ë°”ìœ„ ë¬¸ì„ ë°€ì–´ë³¸ë‹¤.": "__LOSE__", # ë¬¸ì´ ì›€ì§ì´ì§€ ì•ŠìŒ, ë™êµ´ì— ê°‡í˜
            "ë¬¸ì–‘ì„ ìì„¸íˆ ì‚´í´ë³¸ë‹¤.": "examine_cave_door"
        }
    },
    "examine_cave_door": {
        "text": "ë¬¸ì–‘ì„ ì‚´í´ë³´ë‹ˆ, ì˜¤ë˜ëœ í¼ì¦ì´ ìƒˆê²¨ì ¸ ìˆìŠµë‹ˆë‹¤. ê·¸ë¦¬ê³  ì—´ì‡  êµ¬ë©ì´ ë³´ì…ë‹ˆë‹¤.",
        "choices": {
            "ì—´ì‡ ë¥¼ ì‚¬ìš©í•´ë³¸ë‹¤.": "__ITEM_CHECK_KEY__", # ì•„ì´í…œ í™•ì¸ ë¡œì§ íŠ¸ë¦¬ê±°
        },
        "item_check": {
            "ìˆ²ì˜ ì§€í˜œ ì—´ì‡ ": {
                "has": "open_cave_door",
                "lacks": "no_key_for_cave"
            }
        }
    },
    "no_key_for_cave": {
        "text": "ì—´ì‡ ê°€ ì—†ì–´ì„œ ë¬¸ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¹ì‹ ì€ ê²°êµ­ ë™êµ´ì— ê°‡íˆê²Œ ë©ë‹ˆë‹¤.",
        "choices": {
            "ì¢Œì ˆí•œë‹¤.": "__LOSE__"
        }
    },
    "open_cave_door": {
        "text": "ìˆ²ì˜ ì§€í˜œ ì—´ì‡ ë¥¼ ì‚¬ìš©í•˜ë‹ˆ, ë°”ìœ„ ë¬¸ì´ ì²œì²œíˆ ì—´ë¦½ë‹ˆë‹¤! ê·¸ ì•ˆì—ëŠ” ë°ì€ ë¹›ì´ ìŸì•„ì ¸ ë‚˜ì˜¤ê³ , ë‹¹ì‹ ì€ ìƒˆë¡œìš´ ì„¸ìƒìœ¼ë¡œ ë‚˜ì•„ê°‘ë‹ˆë‹¤.",
        "choices": {
            "ë¹›ì„ í–¥í•´ ë‚˜ì•„ê°„ë‹¤.": "__WIN__"
        }
    },
    "cross_bridge": {
        "text": "ì´ë¼ ë‚€ ë‚¡ì€ ë‹¤ë¦¬ë¥¼ ì¡°ì‹¬ìŠ¤ëŸ½ê²Œ ê±´ë„™ë‹ˆë‹¤. ë‹¤ë¦¬ ì¤‘ê°„ì— ì˜¤ë˜ëœ ë‚˜ë¬´ ìƒìê°€ ë†“ì—¬ ìˆìŠµë‹ˆë‹¤.",
        "choices": {
            "ìƒìë¥¼ ì—´ì–´ë³¸ë‹¤.": "open_box_on_bridge",
            "ìƒìë¥¼ ë¬´ì‹œí•˜ê³  ë‹¤ë¦¬ë¥¼ ëê¹Œì§€ ê±´ë„Œë‹¤.": "continue_after_bridge"
        }
    },
    "open_box_on_bridge": {
        "text": "ìƒì ì•ˆì—ëŠ” ê±°ë¯¸ì¤„ì´ ê°€ë“í•˜ê³ , ê·¸ ì•„ë˜ ì‘ì€ 'ë‚¡ì€ ì§€íŒ¡ì´'ê°€ ë†“ì—¬ ìˆìŠµë‹ˆë‹¤.",
        "choices": {
            "ì§€íŒ¡ì´ë¥¼ ì¤ëŠ”ë‹¤.": "__ITEM_GET_KEY__",
            "ê·¸ëƒ¥ ë‹«ê³  ê°„ë‹¤.": "continue_after_bridge"
        },
        "item_get": {"ë‚¡ì€ ì§€íŒ¡ì´": "continue_after_bridge_with_item"}
    },
    "continue_after_bridge": {
        "text": "ë‹¤ë¦¬ë¥¼ ë¬´ì‚¬íˆ ê±´ë„Œ ë‹¹ì‹ ì€ ë„“ì€ ì´ˆì›ì— ë„ì°©í•©ë‹ˆë‹¤. ì € ë©€ë¦¬ ê±°ëŒ€í•œ ì‚°ì´ ë³´ì…ë‹ˆë‹¤. ì‚°ì„ ë„˜ì–´ê°€ì•¼ í•  ê²ƒ ê°™ìŠµë‹ˆë‹¤.",
        "choices": {
            "ì‚°ì„ í–¥í•´ ê°„ë‹¤.": "approach_mountain",
            "ë‹¤ë¥¸ ê¸¸ì„ ì°¾ì•„ë³¸ë‹¤.": "__LOSE__" # ê¸¸ì„ ì°¾ì§€ ëª»í•¨
        }
    },
    "continue_after_bridge_with_item": {
        "text": "ì§€íŒ¡ì´ë¥¼ ë“¤ê³  ë‹¤ë¦¬ë¥¼ ê±´ë„Œ ë‹¹ì‹ ì€ ë„“ì€ ì´ˆì›ì— ë„ì°©í•©ë‹ˆë‹¤. ì € ë©€ë¦¬ ê±°ëŒ€í•œ ì‚°ì´ ë³´ì…ë‹ˆë‹¤. ì‚°ì„ ë„˜ì–´ê°€ì•¼ í•  ê²ƒ ê°™ìŠµë‹ˆë‹¤. ì§€íŒ¡ì´ê°€ ë‹¹ì‹ ì˜ ì†ì—ì„œ í¬ë¯¸í•˜ê²Œ ë¹›ë‚©ë‹ˆë‹¤.",
        "choices": {
            "ì‚°ì„ í–¥í•´ ê°„ë‹¤.": "approach_mountain",
            "ë‹¤ë¥¸ ê¸¸ì„ ì°¾ì•„ë³¸ë‹¤.": "__LOSE__" # ê¸¸ì„ ì°¾ì§€ ëª»í•¨
        }
    },
    "approach_mountain": {
        "text": "ì‚° ê¸°ìŠ­ì— ë„ì°©í•˜ë‹ˆ, ê±°ëŒ€í•œ ëŒë²½ì´ ë‹¹ì‹ ì„ ë§‰ê³  ìˆìŠµë‹ˆë‹¤. ë²½ì—ëŠ” ê³ ëŒ€ ë¬¸ìê°€ ìƒˆê²¨ì ¸ ìˆìŠµë‹ˆë‹¤.",
        "choices": {
            "ê³ ëŒ€ ë¬¸ìë¥¼ í•´ë…í•´ë³¸ë‹¤.": "decipher_runes",
            "ì§€íŒ¡ì´ë¥¼ ì‚¬ìš©í•´ë³¸ë‹¤.": "__ITEM_CHECK_KEY__" # ì•„ì´í…œ í™•ì¸ ë¡œì§ íŠ¸ë¦¬ê±°
        },
        "item_check": {
            "ë‚¡ì€ ì§€íŒ¡ì´": {
                "has": "use_staff_on_mountain",
                "lacks": "no_staff_for_mountain"
            }
        }
    },
    "decipher_runes": {
        "text": "ê³ ëŒ€ ë¬¸ìëŠ” ë„ˆë¬´ ë³µì¡í•˜ì—¬ ë‹¹ì‹ ì˜ ì§€ì‹ìœ¼ë¡œëŠ” í•´ë…í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸¸ì€ ë§‰í˜€ ìˆìŠµë‹ˆë‹¤.",
        "choices": {
            "í¬ê¸°í•œë‹¤.": "__LOSE__"
        }
    },
    "no_staff_for_mountain": {
        "text": "ì§€íŒ¡ì´ê°€ ì—†ì–´ì„œ ëŒë²½ì„ ëš«ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì‚°ì„ ë„˜ì„ ë°©ë²•ì´ ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤.",
        "choices": {
            "í¬ê¸°í•œë‹¤.": "__LOSE__"
        }
    },
    "use_staff_on_mountain": {
        "text": "ë‚¡ì€ ì§€íŒ¡ì´ë¥¼ ëŒë²½ì— ê°€ì ¸ë‹¤ ëŒ€ë‹ˆ, ì§€íŒ¡ì´ê°€ ê°•ë ¬í•˜ê²Œ ë¹›ë‚˜ë©° ëŒë²½ì— ìƒˆë¡œìš´ ë¬¸ì´ ìƒê²¨ë‚©ë‹ˆë‹¤. ê·¸ ë¬¸ì„ í†µê³¼í•˜ì, ë“œë””ì–´ ìˆ²ì„ ë²—ì–´ë‚˜ ììœ ë¥¼ ì–»ê²Œ ë©ë‹ˆë‹¤!",
        "choices": {
            "ìƒˆë¡œìš´ ì„¸ìƒìœ¼ë¡œ ë‚˜ì•„ê°„ë‹¤.": "__WIN__"
        }
    },
    "investigate_scream": {
        "text": "ë¹„ëª…ì†Œë¦¬ê°€ ë‚˜ëŠ” ê³³ìœ¼ë¡œ ê°€ë³´ë‹ˆ, ì‘ì€ ë™ë¬¼ì´ ë«ì— ê±¸ë ¤ ìˆìŠµë‹ˆë‹¤. ë«ì€ ë³µì¡í•œ êµ¬ì¡°ë¡œ ë˜ì–´ ìˆì–´ í•´ì œí•˜ê¸°ê°€ ì–´ë µìŠµë‹ˆë‹¤.",
        "choices": {
            "ë™ë¬¼ì„ êµ¬í•´ì£¼ë ¤ ë…¸ë ¥í•œë‹¤.": "try_to_save_animal",
            "ê·¸ëƒ¥ ì§€ë‚˜ì³ ê°„ë‹¤.": "continue_straight_after_cabin"
        }
    },
    "try_to_save_animal": {
        "text": "ë«ì„ í•´ì œí•˜ëŠ” ë° ë„ˆë¬´ ë§ì€ ì‹œê°„ì„ ì†Œëª¨í–ˆê³ , ê²°êµ­ ìˆ²ì˜ ì–´ë‘ ì— ê°‡íˆê³  ë§™ë‹ˆë‹¤.",
        "choices": {
            "ìš´ëª…ì„ ë°›ì•„ë“¤ì¸ë‹¤.": "__LOSE__"
        }
    },
    "win_ending": {
        "text": "ğŸŠ ì¶•í•˜í•©ë‹ˆë‹¤! ë‹¹ì‹ ì€ ìˆ² ì† ëª¨í—˜ì—ì„œ ì‚´ì•„ë‚¨ì•„ ììœ ë¥¼ ì–»ì—ˆìŠµë‹ˆë‹¤. ë‹¹ì‹ ì˜ ìš©ê¸°ì™€ ì§€í˜œê°€ ë‹¹ì‹ ì„ ìŠ¹ë¦¬ë¡œ ì´ëŒì—ˆìŠµë‹ˆë‹¤!",
        "choices": {} # ê²Œì„ ì¢…ë£Œ
    },
    "lose_ending": {
        "text": "ğŸ’€ ë‹¹ì‹ ì˜ ëª¨í—˜ì€ ì—¬ê¸°ì„œ ëë‚¬ìŠµë‹ˆë‹¤. ì–´ë‘  ì†ì— ê°‡íˆê±°ë‚˜, ì˜ˆìƒì¹˜ ëª»í•œ ìœ„í—˜ì— ì²˜í•˜ê³  ë§ì•˜ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ë³´ì‹œê² ìŠµë‹ˆê¹Œ?",
        "choices": {} # ê²Œì„ ì¢…ë£Œ
    }
}

# --- 2. ìŠ¤íŠ¸ë¦¼ë¦¿ ì•± UI ë° ë¡œì§ ---

st.set_page_config(page_title="ë°¤ ìˆ² ì† ëª¨í—˜", layout="centered")

st.title("ğŸŒ² ë°¤ ìˆ² ì† ëª¨í—˜")
st.markdown("ë‹¹ì‹ ì˜ ì„ íƒì´ ìš´ëª…ì„ ê²°ì •í•©ë‹ˆë‹¤.")

# ê²Œì„ ìƒíƒœ ì´ˆê¸°í™” (ì„¸ì…˜ ìƒíƒœ ì‚¬ìš©)
if 'current_node' not in st.session_state:
    st.session_state.current_node = "start"
    st.session_state.inventory = [] # í”Œë ˆì´ì–´ê°€ íšë“í•œ ì•„ì´í…œ ëª©ë¡
    st.session_state.game_over = False

current_node_id = st.session_state.current_node
current_node = story_nodes[current_node_id]

# --- ê²Œì„ ë¡œì§ ---

# ê²Œì„ ì˜¤ë²„ ìƒíƒœì¼ ê²½ìš°
if st.session_state.game_over:
    if current_node_id == "__WIN__":
        st.success(story_nodes["win_ending"]["text"])
    elif current_node_id == "__LOSE__":
        st.error(story_nodes["lose_ending"]["text"])
    
    if st.button("ìƒˆ ê²Œì„ ì‹œì‘"):
        st.session_state.current_node = "start"
        st.session_state.inventory = []
        st.session_state.game_over = False
        st.rerun() # ë³€ê²½ëœ ë¶€ë¶„: st.experimental_rerun() -> st.rerun()
    
    st.stop() # ê²Œì„ ì˜¤ë²„ ì‹œ ë” ì´ìƒ ì§„í–‰í•˜ì§€ ì•ŠìŒ

# í˜„ì¬ ìŠ¤í† ë¦¬ ë…¸ë“œ í…ìŠ¤íŠ¸ í‘œì‹œ
st.markdown(f"**{current_node['text']}**")

# ì¸ë²¤í† ë¦¬ í‘œì‹œ (ë””ë²„ê¹… ë˜ëŠ” ì •ë³´ ì œê³µìš©)
if st.session_state.inventory:
    st.sidebar.subheader("ë‚˜ì˜ ì¸ë²¤í† ë¦¬")
    for item in st.session_state.inventory:
        st.sidebar.markdown(f"- {item}")
else:
    st.sidebar.info("ì¸ë²¤í† ë¦¬ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.")


# ì„ íƒì§€ ë²„íŠ¼ í‘œì‹œ
for choice_text, next_node_id in current_node['choices'].items():
    if st.button(choice_text):
        # íŠ¹ìˆ˜ í‚¤ì›Œë“œ ì²˜ë¦¬
        if next_node_id == "__END__": # ì´ ì˜ˆì‹œì—ì„œëŠ” ì‚¬ìš©ë˜ì§€ ì•ŠìŒ
            st.session_state.game_over = True
            st.session_state.current_node = "end_node"
        elif next_node_id == "__WIN__":
            st.session_state.game_over = True
            st.session_state.current_node = "__WIN__"
        elif next_node_id == "__LOSE__":
            st.session_state.game_over = True
            st.session_state.current_node = "__LOSE__"
        elif next_node_id == "__ITEM_GET_KEY__":
            # ì•„ì´í…œ íšë“ ë¡œì§
            item_to_get = list(current_node["item_get"].keys())[0] # ì²« ë²ˆì§¸ ì•„ì´í…œë§Œ ì²˜ë¦¬ (ê°„ë‹¨í™”)
            next_real_node = current_node["item_get"][item_to_get]
            if item_to_get not in st.session_state.inventory:
                st.session_state.inventory.append(item_to_get)
                st.success(f"ì•„ì´í…œ íšë“! : **{item_to_get}**")
            st.session_state.current_node = next_real_node
        elif next_node_id == "__ITEM_CHECK_KEY__":
            # ì•„ì´í…œ í™•ì¸ ë¡œì§
            item_to_check = list(current_node["item_check"].keys())[0] # ì²« ë²ˆì§¸ ì•„ì´í…œë§Œ ì²˜ë¦¬ (ê°„ë‹¨í™”)
            if item_to_check in st.session_state.inventory:
                st.session_state.current_node = current_node["item_check"][item_to_check]["has"]
            else:
                st.session_state.current_node = current_node["item_check"][item_to_check]["lacks"]
        else:
            # ì¼ë°˜ì ì¸ ë‹¤ìŒ ë…¸ë“œë¡œ ì´ë™
            st.session_state.current_node = next_node_id
        
        st.rerun() # ë³€ê²½ëœ ë¶€ë¶„: st.experimental_rerun() -> st.rerun()
